{{#section 'head'}}
    <link rel="stylesheet" type="text/css" href="/stylesheets/demo.css"/>
    <link rel="stylesheet" type="text/css" href="/stylesheets/obnoxious.css"/>
    <script src="/recordrtc/RecordRTC.min.js"></script>
    <script src="/socket.io-client/dist/socket.io.slim.js"></script>
{{/section}}
<section class="container content fade in">
    <section class="voice-message-container row">
        <div class="col-xs-12">
            <div class="text-center">
                <button id="unmute-btn" type="button" class="btn btn-link">
                    <span class="glyphicon glyphicon-volume-off" aria-hidden="true"></span> Unmute
                </button>
                <button id="replay-btn" type="button" class="btn btn-link">
                    <span class="glyphicon glyphicon-repeat" aria-hidden="true"></span> Replay
                </button>
            </div>
        </div>
        <div class="col-md-12">
            <p class="voice-message-text fs-2_5x">
            </p>
        </div>

    </section>
    <div id="scroll-to-section" class="col-md-12 text-center scroll-container">
        <a id="go-to-record" data-scroll href="#record-section" class="fade in fs-3x">
            <span class="glyphicon glyphicon-menu-down animated" aria-hidden="true"></span>
        </a>
    </div>
    <section id="record-section" class="row">
        <div class="col-md-12 text-center">
            <button id="show-record-btn" type="button" class="btn btn-link btn-lg fs-4x">
                <span class="glyphicon glyphicon-record" aria-hidden="true"></span><br/>Record
            </button>
        </div>
        <div id="record-container" class="col-md-12 hide">
        <span class="input-group-lg">
            <span class="input-lg">
                <label>Enter a valid email</label>
                <input class="form-control" type="email" autocomplete="off" name="email"
                       placeholder="e.g. tom@gmail.com" style="background: transparent;"/>
            </span>
        </span>
            <div class="audio-controls hide">
                <div class="col-md-12">
                    <canvas id="live-audio-canvas" class=""></canvas>
                    <img id="snapshot">
                    <label class="status on">The mic is hot.....</label>
                    <label class="time-remaining pull-right"></label>

                </div>
                <div class="text-center" role="group" aria-label="...">
                    <button id="record-btn" type="button" class="btn btn-link btn-lg">
                        <span class="glyphicon glyphicon-record" aria-hidden="true"></span> Record
                    </button>
                    <button id="stop-recording-btn" type="button" class="btn btn-link btn-lg">
                        <span class="glyphicon glyphicon-stop" aria-hidden="true"></span> Stop
                    </button>
                    <button id="play-btn" type="button" class="btn btn-link btn-lg">
                        <span class="glyphicon glyphicon-play-circle" aria-hidden="true"></span> replay
                    </button>
                    <button id="delete-upload-btn" type="button" class="btn btn-link btn-lg" data-toggle="tooltip"
                            data-placement="right" title="Recording save automatically but you can delete yours">
                        <span class="glyphicon glyphicon-save" aria-hidden="true"></span> Delete Recording
                    </button>

                </div>
            </div>
            <span>
                    <audio id="camera-preview" controls class="hide"
                           style="border: 1px solid rgb(15, 158, 238); width: 94%;"></audio>
                <span style="display:none;">

                    <progress id="progress-bar" value="0" max="100"></progress>
                    <br/>
                    </span>
                <span>

            </span>
            </span>

            <span class="input-group-lg step-2">
        </span>
            <button type="button" class="btn btn-link next pull-right ">Next</button>
            <!--<button type="button" class="btn btn-link pull-right" id="snap">Capture Image</button>-->
        </div>

    </section>
    <div class="col-md-12 text-center scroll-container">
        <a href="#recorded-section" data-scroll id="" type="button" class="btn btn-link btn-lg fs-4x">
            <span class="glyphicon glyphicon-menu-down animated" aria-hidden="true"></span>
        </a>
    </div>
    <section id="recorded-section" class="row">
        <h2 class="text-center">Previous Recordings</h2>
        <hr/>
        {{#each images}}
            <div class="col-md-6">

                <div class="thumbnail audio-control" id="acid_{{@index}}" data-audio-src="{{this.audio_path}}"
                     data-recording-key="{{this.key}}"
                     data-wave-form="{{this.waveForm}}"
                     data-wave-form-container="wf_{{@index}}">
                    <img src="{{this.image}}" alt="Some image"/>
                    <div id="wf_{{@index}}" style="overflow: hidden;" class="wave-form">
                    </div>
                    <div class="caption">
                        <p>
                            <button type="button" class="play btn btn-link" disabled>
                                <span class="glyphicon glyphicon-play" aria-hidden="true"></span>
                            </button>
                            <button type="button" class="pause btn btn-link" disabled>
                                <span class="glyphicon glyphicon-pause" aria-hidden="true"></span>
                            </button>
                            <button type="button" class="stop btn btn-link" disabled>
                                <span class="glyphicon glyphicon-stop" aria-hidden="true"></span>
                            </button>
                            <button type="button" class="delete btn btn-link btn-lg pull-right" data-toggle="tooltip"
                                    data-placement="right"
                                    title="Recording save automatically but you can delete yours">
                                <span class="glyphicon glyphicon-trash" aria-hidden="true"></span>
                            </button>
                        </p>
                    </div>
                    <div class="row" style="padding: 0 10px 5px 10px !important;margin: 0;">
                        <div class="col-md-12 col-sm-12 text-success">
                            <label class="status pull-left">&nbsp;</label>
                            <label class="duration pull-right">&nbsp;</label>
                        </div>
                    </div>
                </div>
            </div>
        {{/each}}
    </section>
</section>




{{#section 'scripts'}}

    <script src="/lodash/lodash.min.js"></script>
    <script src="/javascripts/EventEmitter.js"></script>
    <script src="/d3/build/d3.min.js"></script>
    <script src="/howler/dist/howler.min.js"></script>
    <script src="/javascripts/Audio-Bundle.js"></script>
    <script src="/javascripts/AudioComponent.js"></script>

    <script>

        function resizeContainer () {
            var h = $(window).height()
            $('.container.content').height(h * 3)
        }
        function repositionCarrot () {
            var h = $(window).height()
            var z = h - (h * 0.05) - $('.voice-message-container').offset().top
//            $('#scroll-to-section').offset({top: z})
//            $('#record-section').offset({top: z + ( z * 0.5)})
        }
        resizeContainer()
        smoothScroll.init()
        repositionCarrot()

        var stats = {step: 1}

        var ci, pos2 = 50

        function progress (elementId) {}

        function init () {

            showTypedVoiceMailMessage()

            var voices = $('div[data-audio-src]').map(function (i, el) {
                return {
                    el: '#' + $(el).prop('id'),
                    recordingKey: $(el).data('recording-key'),
                    waveFormEl: $(el).data('wave-form-container'),
                    waveform: [$(el).data('wave-form').split(',')],
                    controls: {
                        $play: $(el).find('button.play')[0],
                        $pause: $(el).find('button.pause')[0],
                        $stop: $(el).find('button.stop')[0],
                        $delete: $(el).find('button.delete')[0],
                        $status: $(el).find('.status')[0],
                        $duration: $(el).find('.duration')[0]
                    },
                    howl: {
                        src: [$(el).data('audio-src')],
                        autoplay: false,
                        preload: false,
                        loop: false,
                        volume: 0.5
                    }
                }
            }).toArray()

//            console.log('audio components: %s', voices.length)
//            console.log(voices)

            for (var i = 0; i < voices.length; i++) {
                var config = voices[i]
                var audio = new AudioComponent(config)
                audioComponents.push(audio)
            }
            // todo: clear loading dialog
//             progress($(target).data('target-id'))
        }
        var audioComponents = []

        $(document).ready(function () {

            $(window).on('resize', function () {
                if ($(window).scrollTop() === 0) {
                    repositionCarrot()
                }
            })

            init()

            $('[name=email]').keypress(function () {
                if (new RegExp(/.+\@.+\..+/).test($(this).val())) {
                    $('.btn.next').removeClass('hide')

                } else {
                    hideAudioControls()
                }
            })
            $('[name=email]').focusout(function () {
                if (new RegExp(/.+\@.+\..+/).test($(this).val())) {
                    $('.btn.next').removeClass('hide')
//                    incrementStep()
                } else {
                    hideAudioControls()
                }

            })

            $('.next').click(function () {
                //1. hide the previous step
                //2. enable client side socket.io code
                showAudioControls()
            })

            $('#show-record-btn').click(function () {
                $('#record-container').toggleClass('hide')
            })

        })

        function showAudioControls () {
            $('.audio-controls').removeClass('hide')
            initAudio()
        }
        function hideAudioControls () {
            $('.audio-controls').addClass('hide')
        }

        function showTypedVoiceMailMessage () {
            $('.voice-message-text').typed({
                strings: ['Hello, you have reached the voice mail of Eric Miller. Please leave your name, number and a short message and i will get back to you as soon as possible. <br/> Thanks!'],
                typeSpeed: 0,
                html: true,
                showCursor: false,
                startDelay: 0,
                callback: function () {
                    $('#go-to-record').removeClass('hide').children('.glyphicon').addClass('intensifies').fadeIn()
                }
            })
        }

    </script>


{{/section}}