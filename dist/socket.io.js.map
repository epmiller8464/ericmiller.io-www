{"version":3,"sources":["../socket.io.js"],"names":["uuid","require","fs","path","exec","FFmpeg","server","app","opts","transports","log","origins","io","sockets","on","socket","data","fileName","v4","emit","writeToDisk","audio","dataURL","video","merge","set","Set","fileExtension","split","pop","fileRootNameWithBase","filePath","fileID","fileBuffer","existsSync","Buffer","writeFileSync","console","audioFile","join","__dirname","videoFile","mergedFile","source","logger","addInput","err","message","progress","Math","round","percent","has","add","unlink","saveToFile","module","exports"],"mappings":"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","file":"socket.io.js","sourcesContent":["'use strict'\nconst uuid = require('uuid')\nconst fs = require('fs')\nconst path = require('path')\nconst exec = require('child_process').exec\nconst FFmpeg = require('fluent-ffmpeg')\n\nfunction server (app) {\n\n  // var io = require('socket.io').listen(app)\n  var opts = {\n    transports: [\n      'polling',\n      'websocket',\n      'xhr-polling',\n      'jsonp-polling'\n    ],\n    log: false,\n    origins: '*:*'\n  }// 'disconnect' EVENT will work only with 'websocket\n  let io = require('socket.io')(app, opts)\n  io.sockets.on('connection', function (socket) {\n    socket.on('message', function (data) {\n      var fileName = uuid.v4()\n\n      socket.emit('ffmpeg-output', 0)\n\n      writeToDisk(data.audio.dataURL, fileName + '.wav')\n\n      // if it is chrome\n      if (data.video) {\n        writeToDisk(data.video.dataURL, fileName + '.webm')\n        merge(socket, fileName)\n      }\n      // if it is firefox or if user is recording only audio\n      else {\n        // socket.emit('merged', fileName + '.wav')\n      }\n    })\n  })\n\n// isn't it redundant?\n// app.listen(8888);\n  const set = new Set()\n\n  function writeToDisk (dataURL, fileName) {\n    var fileExtension = fileName.split('.').pop(),\n      fileRootNameWithBase = './uploads/' + fileName,\n      filePath = fileRootNameWithBase,\n      fileID = 2,\n      fileBuffer\n\n    // @todo return the new filename to client\n    while (fs.existsSync(filePath)) {\n      filePath = fileRootNameWithBase + '(' + fileID + ').' + fileExtension\n      fileID += 1\n    }\n\n    dataURL = dataURL.split(',').pop()\n    fileBuffer = new Buffer(dataURL, 'base64')\n    fs.writeFileSync(filePath, fileBuffer)\n\n    console.log('filePath', filePath)\n  }\n\n  function merge (socket, fileName) {\n\n    var audioFile = path.join(__dirname, 'uploads', fileName + '.wav'),\n      videoFile = path.join(__dirname, 'uploads', fileName + '.webm'),\n      mergedFile = path.join(__dirname, 'uploads', fileName + '-merged.webm')\n\n    FFmpeg({\n      source: videoFile,\n      logger: 'debug'\n    })\n    .addInput(audioFile)\n    .on('error', function (err) {\n      socket.emit('ffmpeg-error', 'ffmpeg : An error occurred: ' + err.message)\n      console.log(err)\n    })\n    .on('progress', function (progress) {\n      socket.emit('ffmpeg-output', Math.round(progress.percent))\n    })\n    .on('end', function () {\n      if (!set.has(fileName)) {\n        socket.emit('merged', fileName + '-merged.webm')\n        console.log('Merging finished !')\n        set.add(fileName)\n      }\n\n      // removing audio/video files\n      fs.unlink(audioFile)\n      fs.unlink(videoFile)\n    })\n    .saveToFile(mergedFile)\n  }\n}\n\nmodule.exports = server"]}