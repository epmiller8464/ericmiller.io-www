{"version":3,"sources":["../socket.io.js"],"names":["uuid","require","fs","server","app","path","exec","opts","transports","log","origins","io","sockets","on","socket","data","fileName","v4","emit","writeToDisk","audio","dataURL","video","merge","set","Set","fileExtension","split","pop","fileRootNameWithBase","filePath","fileID","fileBuffer","existsSync","Buffer","writeFileSync","console","FFmpeg","audioFile","join","__dirname","videoFile","mergedFile","source","addInput","err","message","progress","Math","round","percent","has","add","unlink","saveToFile","module","exports"],"mappings":"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","file":"socket.io.js","sourcesContent":["'use strict'\nconst uuid = require('uuid')\nconst fs = require('fs')\nfunction server (app) {\n  var path = require('path'),\n    exec = require('child_process').exec\n\n  // var io = require('socket.io').listen(app)\n  var opts = {\n    transports: [\n      'polling',\n      'websocket',\n      'xhr-polling',\n      'jsonp-polling'\n    ],\n    log: false,\n    origins: '*:*'\n  }// 'disconnect' EVENT will work only with 'websocket\n  let io = require('socket.io')(app, opts)\n  io.sockets.on('connection', function (socket) {\n    socket.on('message', function (data) {\n      var fileName = uuid.v4()\n\n      socket.emit('ffmpeg-output', 0)\n\n      writeToDisk(data.audio.dataURL, fileName + '.wav')\n\n      // if it is chrome\n      if (data.video) {\n        writeToDisk(data.video.dataURL, fileName + '.webm')\n        merge(socket, fileName)\n      }\n      // if it is firefox or if user is recording only audio\n      else {\n        // socket.emit('merged', fileName + '.wav')\n      }\n    })\n  })\n\n// isn't it redundant?\n// app.listen(8888);\n  const set = new Set()\n\n  function writeToDisk (dataURL, fileName) {\n    var fileExtension = fileName.split('.').pop(),\n      fileRootNameWithBase = './uploads/' + fileName,\n      filePath = fileRootNameWithBase,\n      fileID = 2,\n      fileBuffer\n\n    // @todo return the new filename to client\n    while (fs.existsSync(filePath)) {\n      filePath = fileRootNameWithBase + '(' + fileID + ').' + fileExtension\n      fileID += 1\n    }\n\n    dataURL = dataURL.split(',').pop()\n    fileBuffer = new Buffer(dataURL, 'base64')\n    fs.writeFileSync(filePath, fileBuffer)\n\n    console.log('filePath', filePath)\n  }\n\n  function merge (socket, fileName) {\n    var FFmpeg = require('fluent-ffmpeg')\n\n    var audioFile = path.join(__dirname, 'uploads', fileName + '.wav'),\n      videoFile = path.join(__dirname, 'uploads', fileName + '.webm'),\n      mergedFile = path.join(__dirname, 'uploads', fileName + '-merged.webm')\n\n    new FFmpeg({\n      source: videoFile\n    })\n    .addInput(audioFile)\n    .on('error', function (err) {\n      socket.emit('ffmpeg-error', 'ffmpeg : An error occurred: ' + err.message)\n      console.log(err)\n    })\n    .on('progress', function (progress) {\n      socket.emit('ffmpeg-output', Math.round(progress.percent))\n    })\n    .on('end', function () {\n      if (!set.has(fileName)) {\n        socket.emit('merged', fileName + '-merged.webm')\n        console.log('Merging finished !')\n        set.add(fileName)\n      }\n\n      // removing audio/video files\n      fs.unlink(audioFile)\n      fs.unlink(videoFile)\n    })\n    .saveToFile(mergedFile)\n  }\n}\n\nmodule.exports = server"]}