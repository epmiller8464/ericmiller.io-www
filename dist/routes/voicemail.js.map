{"version":3,"sources":["../../routes/voicemail.js"],"names":["express","require","router","Router","VoiceMessage","CallLog","createSignedUrl","nets","level","createAudioSignature","moment","csurf","cookie","twiml","MessagingResponse","VoiceResponse","ch","sendSmsNotifications","get","req","res","next","links","context","title","images","phone_number","process","env","TWILIO_NUMBER","find","isTemp","err","docs","render","map","vm","toObject","waveForm","key","push","filter","i","v","reverse","surl","meta","Key","_id","image","audio_path","join","date","created_on","format","site_key","RECAPTCHA_SITE_KEY","csrfToken","elasticNav","post","body","response","remoteip","ip","email","status","json","error","validateSubmitter","result","success","challenge_ts","token","put","jwtid","e","call","console","log","Direction","writeHead","end","cl","From","from_country","FromCountry","timestamp","Timestamp","valueOf","call_sid","CallSid","call_meta","save","doc","nextTick","_call","ME","say","voice","language","loop","record","transcribe","hangup","toString","message","recaptcha","cb","url","RECAPTCHA_SECRET","request","method","encoding","undefined","JSON","parse","module","exports"],"mappings":"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","file":"voicemail.js","sourcesContent":["'use strict'\nvar express = require('express')\nvar router = express.Router()\nconst {VoiceMessage, CallLog} = require('../lib/model')\nconst {createSignedUrl} = require('../lib/authorization')\nconst nets = require('nets')\nconst {level} = require('../level')('tokens')\nconst {createAudioSignature} = require('../lib/token')\nconst moment = require('moment')\nvar csurf = require('csurf')({cookie: true})\nconst {MessagingResponse, VoiceResponse} = require('twilio').twiml\nconst ch = require('../lib/callevent')()\nconst {sendSmsNotifications} = require('../lib/voice-service')\nrouter.get('/', csurf, function (req, res, next) {\n  let links = []\n  let context = {title: 'Web Mail', images: [], phone_number: process.env.TWILIO_NUMBER}\n  VoiceMessage.find({isTemp: false}, (err, docs) => {\n    // let value = JSON.parse(data.value)\n    if (err) {\n      return res.render('voicemail', context)\n    }\n    links = docs.map((vm) => {return vm.toObject()}).map((vm) => {\n      let waveForm = []\n      for (var key in vm.waveForm) {\n        if (vm.waveForm[key])\n          waveForm.push(vm.waveForm[key])\n      }\n      waveForm = waveForm.filter((i, v) => {if (v) return v }).reverse()\n      let surl = createSignedUrl(vm.meta.Key)\n      return {\n        key: vm._id,\n        image: vm.image,\n        audio_path: surl,\n        waveForm: waveForm.join(','),\n        date: moment(vm.created_on).format('LLL')\n      }\n    })\n    links = links.reverse()\n    context.images = links\n    context.site_key = process.env.RECAPTCHA_SITE_KEY\n    context.csrfToken = req.csrfToken()\n    context.elasticNav = true\n\n    res.render('voicemail', context)\n  })\n})\n\nrouter.post('/recaptcha', csurf, (req, res, next) => {\n\n  let body = {response: req.body['g-recaptcha-response'], remoteip: req.ip}\n  let email = req.body.email\n\n  if ((!body.response | !email)) {\n    return res.status(400).json({error: 'Invalid parameters'})\n  }\n\n  validateSubmitter(body.response, body.remoteip, (err, result) => {\n    if (err || !result.success)\n      return res.status(400).json(result)\n    createAudioSignature({email: email, ip: req.ip, challenge_ts: result.challenge_ts}, (err, token) => {\n\n      if (err) {\n        return res.status(400).json({error: 'Could not validate submitter'})\n      }\n\n      level.put(token.jwtid, token, (e, success) => {\n        if (e) {\n          return next(e)\n        }\n\n        return res.status(200).json(token)\n      })\n    })\n  })\n})\n\n// http://dev.ericmiller.io/voicemail/webhook/status/voice\nrouter.post('/webhook/call/status', (req, res, next) => {\n  let call = req.body\n  console.log(req.body)\n  if (call.Direction !== 'inbound') {\n    res.writeHead(200)\n    return res.end()\n  }\n\n  // response.Say(\"Chapeau!\", voice: \"woman\", language: \"fr\");\n  let cl = new CallLog({\n    phone_number: call.From,\n    from_country: call.FromCountry,\n    timestamp: moment(call.Timestamp).valueOf(),\n    call_sid: call.CallSid,\n    call_meta: call\n  })\n\n  cl.save((err, doc) => {\n\n    if (doc) {\n      // todo: send sms\n      // ch.emit('new-call', doc.toObject())\n      process.nextTick((_call) => {\n        sendSmsNotifications('Eric will get back to you ASAP, thanks for stopping by.', _call.From)\n        sendSmsNotifications('You have a new voip mail', process.env.ME)\n      }, call)\n    }\n\n    res.writeHead(200)\n    res.end()\n  })\n})\n\nrouter.post('/webhook/incoming/voice', (req, res, next) => {\n  const twiml = new VoiceResponse()\n  // /webhook/incoming/voice\n  twiml.say({voice: 'alice', language: 'pt-BR', loop: 1}, 'Bom dia.')\n  // twiml.pause({length: 1})\n  twiml.say({\n    voice: 'alice',\n    language: 'en-US',\n    loop: 1\n    // }, 'When your near your computer visit my site at www.ericmiller.io/voicemail and leave me a message. This was built with tweelio\\'s voice api. Chow')\n  }, 'You have reached Eric Millers voip number leave me a message, once i have read it you will receive a text and I will get back to you ASAP if you are human or visit my site at www.ericmiller.io/voicemail.')\n\n  twiml.record({transcribe: true})\n\n  twiml.hangup()\n  console.log(twiml.toString())\n  // response.Say(\"Chapeau!\", voice: \"woman\", language: \"fr\");\n\n  res.writeHead(200, {'Content-Type': 'text/xml'})\n  // res.writeHead(200, {'Content-Type': 'audio/wav'})\n\n  res.end(twiml.toString())\n})\n\nrouter.post('/webhook/incoming/sms', (req, res, next) => {\n  const twiml = new MessagingResponse()\n\n  twiml.message('When your near your computer go https://www.ericmiller.io/voicemail and leave me a message.')\n\n  res.writeHead(200, {'Content-Type': 'text/xml'})\n  res.end(twiml.toString())\n})\n\nrouter.post('/webhook/incoming/sms/error', (req, res, next) => {\n  const twiml = new MessagingResponse()\n\n  twiml.message('The Robots are coming! Head for the hills!')\n\n  res.writeHead(200, {'Content-Type': 'text/xml'})\n  res.end(twiml.toString())\n})\n\nfunction validateSubmitter (recaptcha, ip, cb) {\n  let url = `https://www.google.com/recaptcha/api/siteverify?secret= ${process.env.RECAPTCHA_SECRET}&response=${recaptcha}&remoteip=${ip}`\n  let request = {\n    url: url,\n    method: 'POST',\n    encoding: undefined\n  }\n  nets(request, (err, res, body) => {\n    // console.log(err)\n    return cb(err, JSON.parse(body))\n  })\n}\n\nmodule.exports = router\n"]}