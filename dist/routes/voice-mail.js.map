{"version":3,"sources":["../../routes/voice-mail.js"],"names":["express","require","router","Router","fs","path","url","valueEncoding","level","get","req","res","next","links","createReadStream","keys","values","on","data","value","JSON","parse","waveForm","key","push","filter","i","v","reverse","image","audio_path","join","err","render","title","images","delete","fileName","body","status","json","success","message","del","deleteFileOnDisk","result","cb","unlink","search","console","log","module","exports"],"mappings":"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","file":"voice-mail.js","sourcesContent":["'use strict'\nvar express = require('express')\nvar router = express.Router()\nconst fs = require('fs')\nconst path = require('path')\nconst url = require('url')\nconst {level} = require('../level')('vm', {valueEncoding: 'json'})\n\nrouter.get('/', function (req, res, next) {\n  let links = []\n  level.createReadStream({keys: true, values: true})\n  .on('data', function (data) {\n    // console.log('value=', data)\n    let value = JSON.parse(data.value)\n    let waveForm = []\n    for (var key in value.waveForm) {\n      if (value.waveForm[key])\n        waveForm.push(value.waveForm[key])\n    }\n    waveForm = waveForm.filter((i, v) => {if (v) return v }).reverse()\n    links.push({key: data.key, image: value.image, audio_path: value.audio_path, waveForm: waveForm.join(',')})\n  }).on('end', (err) => {\n    // console.log(links)\n    // let links = fd.map((x) => {return `/uploads/${x}`})\n    res.render('voice-mail', {title: 'Express', images: links})\n    // fs.readdir('./uploads/ig', (error, fd) => {\n    //\n    //   if (!fd) {\n    //     return res.render('voice-mail', {title: 'Express', images: []})\n    //   }\n    //   // let links = fd.filter((x) => { if (/\\.wav/.test()) return x }).map((x) => {return `/uploads/${x}`})\n    //   let links = fd.filter(function (s) {if (/\\.jpg/.test(s))return s }).map((x) => {return `/uploads/ig/${x}`})\n    //   // let links = fd.filter(function (s)  {if (/\\.wav/.test(s))return s }).map((x) => {return `/uploads/${x}`})\n    //\n    // })\n  })\n\n  // res.render('voice-mail', {title: 'Express'})\n})\n\nrouter.delete('/:id', (req, res, next) => {\n  let fileName = ''\n  level.get(req.body.key, function (err, value) {\n    if (err) {\n      res.status(200).json({\n        success: false,\n        message: `Error deleting DB ref for key: ${req.body.key}, message: ${err.message}`\n      })\n    }\n    fileName = value.audio_path\n    level.del(req.body.key, function (err) {\n      if (err) {\n        res.status(200).json({\n          success: false,\n          message: `Error deleting DB ref for key: ${req.body.key}, message: ${err.message}`\n        })\n      }\n      deleteFileOnDisk(fileName, (err, result) => {\n\n        if (err) {\n          res.status(200).json({\n            success: false,\n            message: `Error file on disk for file: ${req.body.fileName}, message: ${err.message}`\n          })\n        }\n        res.status(200).json({success: true, message: 'Recording deleted...'})\n      })\n    })\n  })\n})\n\nfunction deleteFileOnDisk (fileName, cb) {\n  fs.unlink(fileName.search('./uploads') >= 0 ? fileName : `./uploads/${fileName}`, (err) => {\n    if (err) {\n      return cb(err)\n    }\n    console.log(`successfully deleted ${fileName}`)\n    return cb(null, true)\n  })\n}\n\nmodule.exports = router\n"]}