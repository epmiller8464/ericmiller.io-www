{"version":3,"sources":["../../routes/voice-mail.js"],"names":["express","require","router","Router","VoiceMessage","createSignedUrl","nets","level","createAudioSignature","csurf","cookie","twiml","MessagingResponse","VoiceResponse","get","req","res","next","links","find","isTemp","err","docs","render","title","images","map","vm","toObject","waveForm","key","push","filter","i","v","reverse","surl","meta","Key","_id","image","audio_path","join","site_key","process","env","RECAPTCHA_SITE_KEY","csrfToken","post","body","response","remoteip","ip","email","status","json","error","validateSubmitter","result","success","token","challenge_ts","put","jwtid","e","delete","fileName","say","voice","language","loop","pause","length","console","log","toString","writeHead","end","message","recaptcha","cb","url","RECAPTCHA_SECRET","request","method","encoding","undefined","JSON","parse","module","exports"],"mappings":"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","file":"voice-mail.js","sourcesContent":["'use strict'\nvar express = require('express')\nvar router = express.Router()\nconst {VoiceMessage} = require('../lib/model')\nconst {createSignedUrl} = require('../lib/authorization')\nconst nets = require('nets')\nconst {level} = require('../level')('tokens')\nconst {createAudioSignature} = require('../lib/token')\nvar csurf = require('csurf')({cookie: true})\nconst {MessagingResponse, VoiceResponse} = require('twilio').twiml\n\nrouter.get('/', csurf, function (req, res, next) {\n  let links = []\n  VoiceMessage.find({isTemp: false}, (err, docs) => {\n    // let value = JSON.parse(data.value)\n    if (err) res.render('voicemail', {title: 'Express', images: []})\n    links = docs.map((vm) => {return vm.toObject()}).map((vm) => {\n      let waveForm = []\n      for (var key in vm.waveForm) {\n        if (vm.waveForm[key])\n          waveForm.push(vm.waveForm[key])\n      }\n      waveForm = waveForm.filter((i, v) => {if (v) return v }).reverse()\n      let surl = createSignedUrl(vm.meta.Key)\n      return {key: vm._id, image: vm.image, audio_path: surl, waveForm: waveForm.join(',')}\n    })\n    res.render('voicemail', {\n      title: 'Express',\n      images: links,\n      site_key: process.env.RECAPTCHA_SITE_KEY,\n      csrfToken: req.csrfToken()\n    })\n  })\n})\n\nrouter.post('/recaptcha', csurf, (req, res, next) => {\n\n  let body = {response: req.body['g-recaptcha-response'], remoteip: req.ip}\n  let email = req.body.email\n\n  if ((!body.response | !email)) {\n    return res.status(400).json({error: 'Invalid parameters'})\n  }\n\n  validateSubmitter(body.response, body.remoteip, (err, result) => {\n    if (err || !result.success)\n      return res.status(400).json(result)\n    let token = createAudioSignature({email: email, ip: req.ip, challenge_ts: result.challenge_ts})\n\n    if (token.error) {\n      return res.status(400).json({error: 'Could not validate submitter'})\n    }\n\n    level.put(token.jwtid, token, (e, success) => {\n      if (e) {\n        return next(e)\n      }\n\n      return res.status(200).json(token)\n    })\n  })\n})\n\nrouter.post('/save-upload', (req, res, next) => {\n\n  // validateSubmitter(req)\n  res.json()\n\n})\n\nrouter.delete('/:id', (req, res, next) => {\n  let fileName = ''\n\n})\n\nrouter.post('/webhook/incoming/voice', (req, res, next) => {\n  const twiml = new VoiceResponse()\n  // /webhook/incoming/voice\n  twiml.say({voice: 'alice', language: 'pt-BR', loop: 1}, 'Oi, bom dia.')\n  twiml.pause({length: 1})\n  twiml.say({voice: 'alice', language: 'en-US', loop: 1}, 'When your near your computer visit my site at')\n  // twiml.pause({length: 1})\n  twiml.say({voice: 'alice', language: 'en-US', loop: 1}, 'www.ericmiller.io/voicemail and')\n  twiml.say({voice: 'alice', language: 'en-US', loop: 1}, 'leave me a voice message.')\n  twiml.say({voice: 'alice', language: 'en-US', loop: 1}, 'I wrote this with tweelio\\'s voice api.')\n  twiml.say({voice: 'alice', language: 'en-US', loop: 1}, '')\n\n  console.log(twiml.toString())\n  // response.Say(\"Chapeau!\", voice: \"woman\", language: \"fr\");\n\n  res.writeHead(200, {'Content-Type': 'text/xml'})\n  // res.writeHead(200, {'Content-Type': 'audio/wav'})\n\n  res.end(twiml.toString())\n})\n\nrouter.post('/webhook/incoming/sms', (req, res, next) => {\n  const twiml = new MessagingResponse()\n\n  twiml.message('When your near your computer go https://ericmiller.io/voicemail and leave me a message.')\n\n  res.writeHead(200, {'Content-Type': 'text/xml'})\n  res.end(twiml.toString())\n})\n\nrouter.post('/webhook/incoming/sms/error', (req, res, next) => {\n  const twiml = new MessagingResponse()\n\n  twiml.message('The Robots are coming! Head for the hills!')\n\n  res.writeHead(200, {'Content-Type': 'text/xml'})\n  res.end(twiml.toString())\n})\n\nfunction validateSubmitter (recaptcha, ip, cb) {\n  let url = `https://www.google.com/recaptcha/api/siteverify?secret= ${process.env.RECAPTCHA_SECRET}&response=${recaptcha}&remoteip=${ip}`\n  let request = {\n    url: url,\n    method: 'POST',\n    encoding: undefined\n  }\n  nets(request, (err, res, body) => {\n    // console.log(err)\n    return cb(err, JSON.parse(body))\n  })\n}\n\nmodule.exports = router\n"]}